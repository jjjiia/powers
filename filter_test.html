<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Filter features within map view</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
	<script src="static/javascripts/d3.v4.min.js"></script>
	<script src="static/javascripts/topojson.v1.min.js"></script>
  
	<script src="static/javascripts/jquery.min.js"></script>
	<script src="static/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="static/javascripts/queue.v1.min.js"></script>
	<script src="static/javascripts/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="static/stylesheets/jquery-ui.css" />
	<link rel="stylesheet" href="static/bootstrap-3.1.1-dist/css/bootstrap.min.css">
	<script src="static/javascripts/jquery-ui.min.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
#map {
    position:absolute;
    left:0px;
    top:0;
    bottom:0;
    width: 100%;
}
#start{
  position:fixed;
      top: 50%;
      left: 50%;
      width:30em;
        height:18em;
}
#count{
  position: absolute;
  width: 25%;
  top: 30;
  bottom: 0;
  font: 24px Helvetica, sans-serif;
  background-color:rgba(0,0,0,.2);
    color: #ffffff;
    max-height: 100%;
    overflow: hidden;
    z-index:2;
    padding:30px;
}
button{
  font-size:15px;
  padding:10px;
  background-color:#fff;
  color:#000;
  border-radius:5px;
  border:2px solid #fff;
  margin:20px;
  font-weight:bold;
}
</style>

<div id='map'></div>
<div id="start">
    <button onclick="getLocation()">SET TO YOUR LOCATION</button> or     
    <button id='fly'>PLAY FROM RANDOM CITY</button>
</div>
<div id='count'>
</div>



<script>
  $(function() {
  	queue()
      .defer(d3.json,"cities.json")
      .await(dataDidLoad);
  })
  
  function dataDidLoad(error,cities) {
    var randomIndex = getRandomInt(0, cities.length)
    var currentCity = cities[randomIndex]
    var currentCenter = [currentCity.longitude,currentCity.latitude]
    console.log(currentCity)
    d3.select("#fly").html("Start from "+currentCity.city+", "+currentCity.state)
    
    mapboxgl.accessToken = 'pk.eyJ1IjoiampqaWlhMTIzIiwiYSI6ImNpbDQ0Z2s1OTN1N3R1eWtzNTVrd29lMDIifQ.gSWjNbBSpIFzDXU2X5YCiQ';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/jjjiia123/cjd9bcmhe14kj2so4ze5y812e',
        center: currentCenter,
        maxZoom: 22,
        minZoom: 3,
        zoom:19
    });
  
    map.on('load', function() {
        map.addLayer({
            'id': 'museums',
            'type': 'symbol',
            'source': {
                'type': 'geojson',
                'data': 'https://raw.githubusercontent.com/jjjiia/powers/master/data/blockGroupCentroids.geojson'
            },        
            "layout": {
                        "icon-image": "art-gallery-15",
                        "icon-padding": 0,
                          "icon-size": 0,
                        "icon-allow-overlap":true
                    }
            })
            var isAtStart = true;
            document.getElementById('fly').addEventListener('click', function() {
                isAtStart = !isAtStart;
                map.flyTo({
                      center:[-98.35,39],
                      zoom: 4,
                      speed: .2, // make the flying slow
                      curve: 1, // change the speed at which it zooms out
                  });
            });

        map.on('move', function() {
          var museums = map.queryRenderedFeatures({layers:['museums']});
            if (museums) {
                var uMuseums = getUniqueFeatures(museums, "AFFGEOID");
            }
            if(uMuseums.length>0){
              d3.select("#count").html(uMuseums.length+" BLock Groups<br/>")//+uplacesOfWorship.length+" places of worship")
            }
        });
        
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else { 
              //  x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }
        function showPosition(position) {
          console.log([position.coords.latitude,position.coords.longitude])
          map.flyTo({
                center:[position.coords.longitude,position.coords.latitude],
                zoom: 20,
                speed: .2, // make the flying slow
                curve: 1, // change the speed at which it zooms out
            });    
         }
        
        d3.select(".mapboxgl-ctrl-bottom-left").remove()
        d3.select(".mapboxgl-ctrl-bottom-right").remove()
    });
  }
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
function renderListings(features) {
    // Clear any existing listings
    listingEl.innerHTML = '';
    if (features.length) {
        features.forEach(function(feature) {
            var prop = feature.properties;
            var item = document.createElement('a');
            item.href = prop.wikipedia;
            item.target = '_blank';
            item.textContent = prop.name + ' (' + prop.abbrev + ')';
            item.addEventListener('mouseover', function() {
                // Highlight corresponding feature on the map
                popup.setLngLat(feature.geometry.coordinates)
                    .setText(feature.properties.name + ' (' + feature.properties.abbrev + ')')
                    .addTo(map);
            });
            listingEl.appendChild(item);
        });

        // Show the filter input
        filterEl.parentNode.style.display = 'block';
    } else {
        var empty = document.createElement('p');
        empty.textContent = 'Drag the map to populate results';
        listingEl.appendChild(empty);

        // Hide the filter input
        filterEl.parentNode.style.display = 'none';

        // remove features filter
        map.setFilter('airport', ['has', 'abbrev']);
    }
}
function normalize(string) {
    return string.trim().toLowerCase();
}
function getUniqueFeatures(array, comparatorProperty) {
    var existingFeatureKeys = {};
    // Because features come from tiled vector data, feature geometries may be split
    // or duplicated across tile boundaries and, as a result, features may appear
    // multiple times in query results.
    var uniqueFeatures = array.filter(function(el) {
        if (existingFeatureKeys[el.properties[comparatorProperty]]) {
            return false;
        } else {
            existingFeatureKeys[el.properties[comparatorProperty]] = true;
            return true;
        }
    });
    return uniqueFeatures;
}


</script>

</body>
</html>