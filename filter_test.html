<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Filter features within map view</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
	<script src="static/javascripts/d3.v4.min.js"></script>
	<script src="static/javascripts/topojson.v1.min.js"></script>
  
	<script src="static/javascripts/jquery.min.js"></script>
	<script src="static/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="static/javascripts/queue.v1.min.js"></script>
	<script src="static/javascripts/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="static/stylesheets/jquery-ui.css" />
	<link rel="stylesheet" href="static/bootstrap-3.1.1-dist/css/bootstrap.min.css">
	<script src="static/javascripts/jquery-ui.min.js"></script>
    <style>
        body { background-color:#000;margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>

#map {
    position:absolute;
    left:0px;
    top:0;
    bottom:0;
    width: 100%;
}
#start{
  position:absolute;
      top: 0px;
      left: 0px;
  visibility: hidden;
        
}
#intro{
  position:fixed;
      top: 10px;
      right: 50px;
        color:#fff;
        font-size:14px;
}
#count{
  position: absolute;
  top: 20px;
  font: 24px Helvetica, sans-serif;
  background-color:rgba(0,0,0,.2);
    color: #ffffff;
    max-height: 100%;
    overflow: hidden;
    z-index:2;
    padding:30px;
}
#infoText{
  position: absolute;
  width: 1%;
  top: 0px;
  left:0px;
  height:10%;
  font: 12px Helvetica, sans-serif;
    color: #ffffff;
    max-height: 100%;
    overflow: hidden;
    z-index:1;
    padding:30px;
}
button{  
  font-size:12px;
  padding:6px;
  background-color:rgba(255,255,255,1);
  color:#000;
  border-radius:4px;
  margin:0px;
  font-weight:bold;
  z-index:4;
  
}
#scale{
  height:500px;
  width:100px;
  position:absolute;
  right:10px;
  top:200px;
}
#powerBase{
  height:20px;
  width:20%;
  position:absolute;
  right:40%;
  top:40%;
  text-align:center;
  font-size:50px;
  color:rgba(255,255,255,.6);
}
#power{
  height:20px;
  width:20%;
  position:absolute;
  right:40%;
  top:40%;
  text-align:center;
  font-size:20px;
  color:rgba(255,255,255,.6);
  padding-left:70px;
}
</style>

<div id='map'></div>
<div id='infoText'>
</div>
<div id="start">
  <div id = "intro">
    <button id='fly'></button>  or recenter 
  </div>
</div>
<div id='count'>
</div>
<div id='power'></div>
<div id='powerBase'></div>
<div id='scale'>
</div>

<script>
  $(function() {
  	queue()
      .defer(d3.json,"cities.json")
      .defer(d3.json,"dictionary_short.json")
      .defer(d3.json,"dictionary_birth.json")
      .defer(d3.csv,"R11573760_SL150.csv")
      .defer(d3.csv,"R11573765_SL140.csv")
      .defer(d3.csv,"R11573767_SL050.csv")
      .await(dataDidLoad);
  })
  
  function dataDidLoad(error,cities,dataDictionary,dataDictionaryBirth,blockGroup,tract,county) {
//    console.log(dataDictionary)
//    console.log(blockGroup)
//    console.log(tract)
//    console.log(county)
    
    d3.selectAll("#start").transition().style("opacity",1).style("visibility","visible")
    
    
    var randomIndex = getRandomInt(0, cities.length)
    var currentCity = cities[randomIndex]
    var currentCenter = [currentCity.longitude,currentCity.latitude]
    d3.select("#fly").html("Start from "+currentCity.city+", "+currentCity.state)
    d3.select("#play").html("play")
    
    mapboxgl.accessToken = 'pk.eyJ1IjoiampqaWlhMTIzIiwiYSI6ImNpbDQ0Z2s1OTN1N3R1eWtzNTVrd29lMDIifQ.gSWjNbBSpIFzDXU2X5YCiQ';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/jjjiia123/cjd9bcmhe14kj2so4ze5y812e',
        center: currentCenter,
        maxZoom: 22,
        minZoom: 3,
        zoom:22
    });
    
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true
    }), "top-right");  
    
map.on('load', function() {
        map.addLayer({
          'id': 'blockGroup',
          'type': 'symbol',
          'maxzoom':17,
          'minzoom':14,
            'source': {
              //'cluster':true,
                'type': 'geojson',
                'data': 'https://raw.githubusercontent.com/jjjiia/powers/master/data/blockGroupCentroids.geojson'
            },        
            "layout": {
                "icon-image": "art-gallery-15",
                "icon-padding": 0,
                "icon-size": 0,
                "icon-allow-overlap":true
                }
            })
            map.addLayer({
                'id': 'tract',
                'type': 'symbol',
              'maxzoom':15,
              'minzoom':12,
                'source': {
                  //'cluster':true,
                    'type': 'geojson',
                    'data': 'https://raw.githubusercontent.com/jjjiia/powers/master/data/tract_centroids.geojson'
                },        
                "layout": {
                            "icon-image": "art-gallery-15",
                            "icon-padding": 0,
                              "icon-size": 0,
                            "icon-allow-overlap":true
                        }
                })
                map.addLayer({
                    'id': 'county',
                    'type': 'symbol',
                  'maxzoom':13,
                  'minzoom':3,
                    'source': {
                      //'cluster':true,
                        'type': 'geojson',
                          'data':'https://raw.githubusercontent.com/jjjiia/powers/master/data/county_centroids.geojson'
                    },        
                    "layout": {
                                "icon-image": "art-gallery-15",
                                "icon-padding": 0,
                                  "icon-size": 0,
                                "icon-allow-overlap":true
                            }
                    })
                    
        var isAtStart = true;
        document.getElementById('fly').addEventListener('click', function() {
          d3.select("#fly").html("stop")
         // d3.selectAll("#start")
         
         // .transition().duration(1000).style("opacity",0).style("display","hidden").remove()
         
         //   isAtStart = !isAtStart;
            map.flyTo({
                  center:[-98.35,39],
                  zoom: 4,
                  speed: .1, // make the flying slow
               //   curve: 1, // change the speed at which it zooms out
              });
        });
        var zoomLevel = map.getZoom();
        if(zoomLevel <=3.1){
          //   isAtStart = !isAtStart;
             map.flyTo({
                   //center:[-98.35,39],
                   zoom: 18,
                   speed: .1, // make the flying slow
                //   curve: 1, // change the speed at which it zooms out
               });
        }
        
        
        
        map.on('move', function() {
          var blockgroups = map.queryRenderedFeatures({layers:['blockGroup']});
          var tracts = map.queryRenderedFeatures({layers:['tract']});
          var counties = map.queryRenderedFeatures({layers:['county']});

          var zoomLevel = map.getZoom();
          var circleScale = d3.scaleLinear().domain([3,22]).range([280,40])
          //d3.select("circle .scale").transition().attr("cy",circleScale(zoomLevel))
        d3.selectAll("circle").transition().attr("cy",300-circleScale(zoomLevel))
          
          if (blockgroups) {
            if (blockgroups.length>0){
           //   if(Math.round(zoomLevel*100)%15==0){
                var uBlockGroups = getUniqueFeatures(blockgroups, "AFFGEOID")
               // console.log(zoomLevel)
              d3.select("#count").html(blockgroups.length+" BLock Groups<br/>")              
                getData(uBlockGroups,blockGroup,dataDictionary,dataDictionaryBirth)
             // }
            }//+uplacesOfWorship.length+" places of worship")
          }

          if (tracts){
            if (tracts.length>0){
         //     if(Math.round(zoomLevel*100)%10==0){
              
              d3.select("#count").html(tracts.length+" tracts<br/>")//+uplacesOfWorship.length+" places of worship")
                var utracts = getUniqueFeatures(tracts, "AFFGEOID")
                getData(utracts,tract,dataDictionary,dataDictionaryBirth)
         //     }
            }
          }
          

          if (counties){
            if (counties.length>0){
          //    if(Math.round(zoomLevel*100)%3==0){
              d3.select("#count").html(counties.length+" counties<br/>")
                var ucounties = getUniqueFeatures(counties, "AFFGEOID")
                getData(ucounties,county,dataDictionary,dataDictionaryBirth)
            //}
          }
          }
        });
        
      //  d3.select(".mapboxgl-ctrl-bottom-left").remove()
        d3.select(".mapboxgl-ctrl-bottom-right").remove()
        drawScale()
    });
  }
function getData(geoids,data,dataDictionary,dataDictionaryBirth){
  var filtered = data.filter(function(el){
    if(geoids.indexOf(el["Geo_GEOID"])>-1){
      return true
    }
  })
  var formatted = {}
  var text = ""
  var columnsFromData = Object.keys(data[0])
  var dataDictionaryKeys = Object.keys(dataDictionary)
  var dataDictionaryKeysBirth = Object.keys(dataDictionaryBirth)
  
  var randomIndex = Math.round(Math.random()*(columnsFromData.length))
  var w = window.innerWidth;
  var h = window.innerHeight;
//  console.log(randomIndex)
  var colors = ["#f0c87e","#e1baf6","#96e8a0","#6be8d9","#d4e38b"]
  
  var totalPopulation = getSum(filtered,"SE_T004_001")
  var totalHouseholds = getSum(filtered,"SE_T017_001")
//  console.log([totalPopulation,totalHouseholds])
  
  //console.log("length "+String(totalPopulation).length)
  
 // d3.select("#powerBase").html("10<br/>people").attr("opacity",0)
  
  var previousPower = d3.select("#power").html()
  if(String(totalPopulation).length>previousPower){
    d3.select("#powerBase").html("10<br/>Americans")
    
    d3.select("#power").html(String(totalPopulation).length-1)    
    //setTimeout(function(){
    //d3.select("#power").html("")    
    //d3.select("#powerBase").html("")    
    //  
    //}, 1000);
  }
  
  
  var titleText = d3.select("#count").html() 
//  console.log(titleText)
  d3.select("#count").html(titleText+"<br/>"+totalPopulation+" people<br/>"+totalHouseholds+" households")
 // for(var i in columnsFromData){
 //   var sum = getSum(filtered,columnsFromData[i])
    var sum = getSum(filtered,columnsFromData[randomIndex])
   //  var dataKey = columnsFromData[randomIndex].replace("SE_","")
   //
   //  var xScale = d3.scaleLinear().domain([0,w]).range([500,w-500])
   //  var yScale = d3.scaleLinear().domain([0,h]).range([100,h-100])
   //
   // if(dataDictionaryKeys.indexOf(dataKey)>-1 && sum >0){
   //   text+=dataDictionary[dataKey].replace("XXX",sum)+".<br/>"
   //   var svg = d3.select("#map").append("div").html(text).style("position","absolute")
   //   //.style("background-color","rgba(0,0,0,0)")
   //   .style("left",xScale(Math.random()*w)+"px")
   //   //.style("left","30px")
   //   .style("top",yScale(Math.random()*h)+"px")
   //   .style("color","#fff").style("text-align","center")
   //   .style("width","600px")
   //   .style("font-size","20px")
   //   .style("text-shadow","0px 0px 20px #aaa")
   //   .transition()
   //   .style("font-size","10px")
   //   .delay(500).duration(2000)
   //
   //   .style("opacity",0).remove()
      //console.log([columnsFromData[i],dataDictionary[dataKey].replace("XXX",sum),sum])
 //   }
  //}
 // d3.select("#infoText").html(text)
}
function drawScale(){
  var svg = d3.select("#scale").append("svg").attr("height",400).attr("width",100)
  var data = new Array(13);
  svg.append("text").text("United States").attr("x",50).attr("y",20).attr("fill","#fff")
    .attr("text-anchor","middle")
  svg.append("text").text("You").attr("x",50).attr("y",310).attr("fill","#fff")
    .attr("text-anchor","middle")
  
  svg.append("circle").attr("class","scale")
    .attr("cx",50)
    .attr("cy",280)
    .attr("r",10)
    .attr("stroke","#fff")
    .attr("fill","none")
  svg.selectAll("rect")
    .data(data)
    .enter()
    .append("rect")
    .attr("x",40)
    .attr("y",function(d,i){
      return i*20+40
    })
    .attr("height",2)
    .attr("width",20)
    .attr("fill","#fff")
}
function getTime() {
    var d = new Date();
   // document.getElementById("demo").innerHTML = d.toLocaleTimeString();
    return d
}
function getSum(obj,column) {
  var sum = 0;
  for( var el in obj ) {
    if( obj.hasOwnProperty( el ) ) {
      sum += parseFloat( obj[el][column] );
    }
  }
  return sum;
}
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
function renderListings(features) {
    // Clear any existing listings
    listingEl.innerHTML = '';
    if (features.length) {
        features.forEach(function(feature) {
            var prop = feature.properties;
            var item = document.createElement('a');
            item.href = prop.wikipedia;
            item.target = '_blank';
            item.textContent = prop.name + ' (' + prop.abbrev + ')';
            item.addEventListener('mouseover', function() {
                // Highlight corresponding feature on the map
                popup.setLngLat(feature.geometry.coordinates)
                    .setText(feature.properties.name + ' (' + feature.properties.abbrev + ')')
                    .addTo(map);
            });
            listingEl.appendChild(item);
        });

        // Show the filter input
        filterEl.parentNode.style.display = 'block';
    } else {
        var empty = document.createElement('p');
        empty.textContent = 'Drag the map to populate results';
        listingEl.appendChild(empty);

        // Hide the filter input
        filterEl.parentNode.style.display = 'none';

        // remove features filter
        map.setFilter('airport', ['has', 'abbrev']);
    }
}
function normalize(string) {
    return string.trim().toLowerCase();
}
function getUniqueFeatures(array, comparatorProperty) {
    var existingFeatureKeys = {};
    var ids = []
    // Because features come from tiled vector data, feature geometries may be split
    // or duplicated across tile boundaries and, as a result, features may appear
    // multiple times in query results.
    var uniqueFeatures = array.filter(function(el) {
        if (existingFeatureKeys[el.properties[comparatorProperty]]) {
            return false;
        } else {
            existingFeatureKeys[el.properties[comparatorProperty]] = true;
          ids.push(el.properties[comparatorProperty].replace("00000","000"))
            return true;
        }
    });
//    console.log(ids)
    return ids
    //return uniqueFeatures;
}
function getLocation() {
    if (navigator.geolocation) {
       var position = navigator.geolocation.getCurrentPosition(showPosition);
       return position
   //     var position = navigator.geolocation.getCurrentPosition()
     //   return position
    } else { 
      //  x.innerHTML = "Geolocation is not supported by this browser.";
    }
}
function showPosition(position) {
  currentPosition = position
  console.log(position)
  return position
 // console.log([position.coords.latitude,position.coords.longitude])
 }

</script>

</body>
</html>